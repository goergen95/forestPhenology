---
output: 
  pdf_document:
    toc: true
    toc_depth: 2
    number_sections: true
    df_print: kable
    latex_engine: pdflatex
    fig_caption: true
bibliography: ForestPhenology.bib
csl: elsevier-harvard.csl
title: "UAV imagery based tree species classification in the Marburg OpenForest"
author: 
- Darius A. Görgen
- Tobias Koch
- Marvin Müsgen
- Eike Schott
date: "`r format(Sys.time(), '%B %d, %Y')`"

abstract: "The monitoring of forests environments is of crucial importance since they serve as natural habitats and constitute a main source of biological diversity. Yet, it is very costly and labor intensive to monitor forests by traditional means. Recently, there have been several attempts to use UAV-borne imagery in forest monitoring since these images can be obtained at low cost and can come with both, high spatial and temporal resolution which enable scientists and practitioners to comprehensively monitor forest environments. Tree species identification is primary interest, since the identification of species allows to draw conclusions about the structure and biodiversity in given areas of a forest. When using simple RGB images, species classification still remains a challenge. In this paper we present our results of an experiment exploring the influence of spatial resolution of RGB imagery, artificially derived vegetation indices as well as seasonal parameters on the accuracy of tree species classification within the Marburg OpenForest. We used a resolution of 5 cm, 10 cm, 15 cm, and 25 cm in a forwar-feature-selection based on the RandomForest classification algorithm. Additionally we tested the obtained accuracy when only mono-temporal or multi-temporal variables are included as well as both types of variables. Our results show that ..."

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tmap)
library(caret)
library(raster)
```

# Introduction

Forests environments provide valuabel services to the human well being as well as 
supporting services to the function of ecosystems. Additionally, they count to 
the main biodiversity hotspots on earth [@Brockerhoff2017]. However, the most recent
Global Forest Ressource Assessment of the FAO states, that the global forest area
shrinked between 1990 and 2015 from 31.6% of the global land cover to 30.6%, or in 
other numbers from 4,128 Mio. ha to 3,999 Mio. ha - a decrease of 3.1% [@FoodandAgricultureOrgansiationoftheUnitedNations2015].
Simultaniously, the percentage of planted trees increased by over 105 Mio. ha, 
reducing the share of natural forest areas. Over the last decades, we can find 
scholary interests on ecosystem services and functions which are sustained by forests,
mainly the habitat provision for endangered or native species, the provision of 
material goods such as wood biomass, soil formation and composition, as well as 
climatic regulation functions, such as carbon sequestration [@Brockerhoff2017].
One of the main critical variables in assessing the quality of forest envrionments,
their biodiversity, and their structural attributes is the tree species, either on
the individual tree level or the dominating species for coarser areas of interest. 

Identifying tree species, however, on an operative scale for larger areas, remains a challenge.
Recently, different remote sensing approaches proved that tree species identification
from above the earth's surface is feasiable, but there still remain significant 
trade-offs between the costs, computational demand and spatial-temporal resolution of
remotly sensed imagery.


# Data and Method

The UAV imageries were obtained through the use of a GoPro x.x and an overpass over the region
in approximatley 40 meters height. Orthorectified photos were created by the use of the
AgiSoft OpenSource Software. In total we worked on 6 images which were obtained between the end of April to 
the end of June. In the mitlatitudes of central Europe these are the months of vegetational
peak of mixed forests. We calculated a selection of RGB-based vegetational indices for each
of the images as well as seasonal statistics which describe the development of these indices
in the course of the vegetation period.

- UAV orthoimages, AgiSoft (how-to), flight height
- pre-process: crop to AOI, spatial aggregations different resolutions, indices, season parameters
- tree shape: differential GPS points, >= 40cm DBH, 2m buffer, squares -> species
- RF model, 5-fold cross validation, training vs. testing, kappa & accuracy,
- plots predictors (all, indices, seasons) vs. resolutions 


```{r dates-table, echo=F, tab.cap="Days of UAV overpass.",}
dates = unique(readRDS("../../data/resampled/dates.rds"))
dates = as.Date(dates, format = "%Y_%m_%d" )
dates = data.frame(Dates=dates)
knitr::kable(dates, align="l", caption = "Dates of the UAV overpasses.",)

```
```{r cv_visualization, warning=F,message=F,echo=F}
trees = rgdal::readOGR("../../data/trees_buffer.shp" )
trees@data$polID = seq(nrow(trees@data))
set.seed(1899)
index = caret::createDataPartition(y = trees@data$polID, p = .70, list = FALSE)
pred = trees@data[-index, ]
ind = CAST::CreateSpacetimeFolds(pred, spacevar = "polID", k = 5)

trees@data$train[index] = 0
trees@data$train[-index] = 1

trees@data$cv1[trees$id %in%pred$id[ind$index[[1]]]] = 1
trees@data$cv1[trees$id %in%pred$id[ind$indexOut[[1]]]] = 0

trees@data$cv2[trees$id %in%pred$id[ind$index[[2]]]] = 1
trees@data$cv2[trees$id %in%pred$id[ind$indexOut[[2]]]] = 0

trees@data$cv3[trees$id %in%pred$id[ind$index[[3]]]] = 1
trees@data$cv3[trees$id %in%pred$id[ind$indexOut[[3]]]] = 0

trees@data$cv4[trees$id %in%pred$id[ind$index[[4]]]] = 1
trees@data$cv4[trees$id %in%pred$id[ind$indexOut[[4]]]] = 0

trees@data$cv5[trees$id %in%pred$id[ind$index[[5]]]] = 1
trees@data$cv5[trees$id %in%pred$id[ind$indexOut[[5]]]] = 0

rgbimage = raster::stack("../../data/resampled/res25.tif")
rgb_names = readRDS("../../data/resampled/names_RGB_stack.rds")
names(rgbimage) = rgb_names 

rgbimage = rgbimage[[13:15]]


tm_shape(rgbimage)+
  tm_rgb()+
  tm_shape(trees)+
  tm_fill(col = "train", palette = "RdBu")


tm_shape(rgbimage)+
  tm_rgb()+
  tm_shape(trees, col = c("red","blue","grey"))+
  tm_polygons(c("cv1","cv2","cv3","cv4","cv5"))

```

# Results


# Sources
Example citation [@Ulsig2017a].


